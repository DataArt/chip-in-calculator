<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="cic-contributors.html">
<link rel="import" href="cic-result.html">
<link rel="import" href="cic-share.html">

<dom-module id="cic-main">
    <template>
        <!-- todo: add help modal vindow -->
        <div class="horizontal layout center-justified">
            <cic-share></cic-share>
        </div>
        <div class="horizontal layout center-justified">
            <cic-contributors contributors="{{contributors}}"></cic-contributors>
        </div>
        <div class="horizontal layout center-justified">
            <paper-item>
                <paper-button id="show-results" raised on-click="showResults" disabled>Show Results</paper-button>
                <paper-button raised id="add" on-click="_addContributor">
                    <iron-icon icon="add"></iron-icon> Contributor
                </paper-button>
            </paper-item>
        </div>
        <cic-result id="result" result="{{result}}"></cic-result>
    </template>
</dom-module>

<script>
    Polymer({
        is: "cic-main",
        properties: {
            "contributors": {
                type: Array,
                value: function(){return []}
            },
            "totalValue": {
                type: Number,
                value: 0
            },
            "averagePayment": {
                type: Number,
                value: 0
            }
        },
        observers: [
            '_contributorsChanged(contributors.*)'
        ],
        ready: function(){
            this.result = {};
            this.push('contributors', this._clone(this._emptyContributor));
        },
        showResults: function(){
            if (this.totalValue > 0 && this.contributors.length > 1) {
                this.calculate();
                this.$.result.openDialog()
            } else {
                this.result = {};
            }
        },
        calculate: function(){

            var _this = this;
            var contributors = this._clone(this.contributors);

            var arr = [],
                i = 0, j = 0,
                totalValue = contributors.reduce(function(p,c){return p+ c.value}, 0);

            this.averagePayment = this.totalValue/contributors.length;

            arr = contributors.map(function(d){
                d.value = _this.averagePayment - d.value;
                return d;
            });

            var debtors = arr.filter(function(item){return item.value > 0}); // all positive
            var lenders = arr.filter(function(item){return item.value < 0}); // all negative
            var lender = lenders[0];
            var debtor = debtors[0];
            var values = [];
            var delta = 0;

            while (lenders.length > 0 && debtors.length > 0) {
                lender = lender || lenders[0];
                debtor = debtor || debtors[0];
                delta = debtor.value + lender.value;

                if (delta < 0) {
                    values.push({
                        from: debtor.name,
                        to: lender.name,
                        value: debtor.value
                    });
                    lender.value += debtor.value;
                    debtor.value = 0;
                } else {
                    values.push({
                        from: debtor.name,
                        to: lender.name,
                        value: -lender.value
                    });
                    debtor.value += lender.value;
                    lender.value = 0;
                }

                if (debtor.value === 0) {
                    debtors.splice(0, 1);
                    debtor = null;
                }
                if (lender.value === 0) {
                    lenders.splice(0, 1);
                    lender = null;
                }

                delta = 0;
            }

            this.result = {
                values: values,
                totalValue: this.totalValue,
                averagePayment: this.averagePayment
            };
        },
        _clone: function (obj) {
            var copy = null,
                _this = this;

            // Handle the 3 simple types, and null or undefined
            if (null == obj || "object" != typeof obj) return obj;

            // Handle Date
            if (obj instanceof Date) {
                copy = new Date();
                copy.setTime(obj.getTime());
                return copy;
            }

            // Handle Array
            if (obj instanceof Array) {
                copy = [];
                for (var i = 0, len = obj.length; i < len; i++) {
                    copy[i] = _this._clone(obj[i]);
                }
                return copy;
            }

            // Handle Object
            if (obj instanceof Object) {
                copy = {};
                for (var attr in obj) {
                    if (obj.hasOwnProperty(attr)) copy[attr] = _this._clone(obj[attr]);
                }
                return copy;
            }

            throw new Error("Unable to copy obj! Its type isn't supported.");
        },
        _addContributor: function(){
            this.push('contributors', this._clone(this._emptyContributor));
        },
        _contributorsChanged: function(){
            var contributors = this.contributors;

            contributors.forEach(function(d){
                d.value = parseFloat(d.value) || 0;
            });

            this.totalValue = contributors.reduce(function(p,c){
                return p + c.value
            }, 0);

            this.$['show-results'].disabled = contributors.length < 2
        },
        _emptyContributor: {"name":"","value":0}
    });
</script>
